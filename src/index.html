<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Spell Converter - RevScript</title>
  <style>
    :root {
      --bg: #0f172a;
      --bg-card: #111827;
      --accent: #2563eb;
      --accent-soft: #1d4ed8;
      --border: #1f2937;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #ef4444;
      --success: #22c55e;
      --radius: 10px;
      --shadow: 0 18px 45px rgba(0, 0, 0, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      font-size: 16px;
      background: #020617;
      color: var(--text);
      overflow: hidden;
    }

    .app {
      width: 100%;
      height: 100%;
      background: linear-gradient(145deg, #020617 0%, #020617 40%, #0b1120 100%);
      padding: 24px;
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 24px;
      overflow: hidden;
    }

    .left,
    .right {
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: 100%;
      overflow-y: auto;
      padding-right: 8px;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(55, 65, 81, 0.8);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(75, 85, 99, 1);
    }

    .header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 8px;
    }

    .logo {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      box-shadow: 0 0 25px rgba(37, 99, 235, 0.25);
    }

    .logo img {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      object-fit: cover;
      display: none;
    }

    .logo-text {
      font-size: 24px;
      color: #eff6ff;
      background: radial-gradient(circle at 30% 0%, #60a5fa, #1d4ed8 45%, #020617 100%);
      width: 100%;
      height: 100%;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    h1 {
      font-size: 24px;
      margin: 0;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .subtitle {
      font-size: 14px;
      color: var(--text-soft);
    }

    .card {
      background: radial-gradient(circle at 0 0, rgba(37, 99, 235, 0.22) 0, rgba(15, 23, 42, 0.96) 36%, #020617 120%);
      border-radius: var(--radius);
      padding: 16px;
      border: 1px solid var(--border);
      position: relative;
      overflow: visible;
    }

    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at 120% -20%, rgba(56, 189, 248, 0.12), transparent 55%);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #9ca3af;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.12);
      color: #93c5fd;
      font-size: 12px;
      border: 1px solid rgba(37, 99, 235, 0.35);
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }

    label {
      font-size: 14px;
      color: var(--text-soft);
    }

    input[type="file"],
    input[type="text"] {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 8px;
      border: 1px solid rgba(31, 41, 55, 1);
      padding: 10px 12px;
      font-size: 14px;
      color: var(--text);
      outline: none;
      width: 100%;
    }

    input[type="file"] {
      padding: 5px 7px;
    }

    input[type="file"]::-webkit-file-upload-button {
      border: none;
      background: linear-gradient(135deg, #1d4ed8, #3b82f6);
      color: white;
      padding: 5px 10px;
      margin-right: 8px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.11em;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.2s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #1d4ed8, #3b82f6);
      color: white;
      box-shadow: 0 12px 35px rgba(37, 99, 235, 0.4);
      width: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(37, 99, 235, 0.55);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 10px 26px rgba(37, 99, 235, 0.35);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      border: 1px solid rgba(55, 65, 81, 1);
      padding-inline: 10px;
    }

    .btn-secondary:hover {
      background: rgba(17, 24, 39, 1);
    }

    #clearLogBtn {
      text-transform: none;
      letter-spacing: 0.04em;
      font-weight: 600;
    }

    .toolbar {
      margin-left: auto;
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }

    .select {
      appearance: none;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(31, 41, 55, 1);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
    }

    .status-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: var(--text-soft);
      margin-top: 8px;
      gap: 10px;
    }

    .version-selector {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    .center-label {
      display: block;
      text-align: center;
    }

    .version-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid rgba(55, 65, 81, 0.6);
      background: rgba(15, 23, 42, 0.7);
      color: #9ca3af;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      line-height: 1.3;
    }

    .version-btn:hover {
      background: rgba(17, 24, 39, 1);
      border-color: rgba(96, 165, 250, 0.5);
    }

    .version-btn.active {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.2), rgba(29, 78, 216, 0.15));
      border-color: #2563eb;
      color: #60a5fa;
      box-shadow: 0 0 15px rgba(37, 99, 235, 0.3);
    }

    .version-desc {
      font-size: 8px;
      color: #6b7280;
      text-transform: none;
      letter-spacing: normal;
      margin-top: 2px;
      font-weight: 400;
      line-height: 1.2;
    }

    .version-btn.active .version-desc {
      color: #93c5fd;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--success);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.7);
      margin-right: 6px;
    }

    .status-ok,
    .status-warn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .status-warn .dot {
      background: #facc15;
      box-shadow: 0 0 12px rgba(250, 204, 21, 0.7);
    }

    .spells-list {
      max-height: 280px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid rgba(31, 41, 55, 1);
      background: rgba(15, 23, 42, 0.9);
      font-size: 14px;
      margin-bottom: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }


    .spells-list th:nth-child(n) {
      width: auto !important;
    }

    th,
    td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 1);
      white-space: nowrap;
    }

    th {
      position: sticky;
      top: 0;
      background: #020617;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
    }

    tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.7);
    }

    .tag {
      display: inline-flex;
      padding: 1px 7px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 1);
      background: rgba(17, 24, 39, 0.9);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
    }

    .tag-attack {
      border-color: #f97316;
      color: #fed7aa;
    }

    .tag-support {
      border-color: #22c55e;
      color: #bbf7d0;
    }

    .tag-healing {
      border-color: #38bdf8;
      color: #bae6fd;
    }

    .pill {
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(31, 41, 55, 1);
      padding: 3px 8px;
      font-size: 11px;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    #baseId {
      width: 50px;
      border: none;
      background: transparent;
      padding: 0 2px;
      color: #e5e7eb;
      font-size: 12px;
    }

    #convertBtn {
      background: linear-gradient(135deg, #1d4ed8, #3b82f6);
      color: white;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.35);
      width: auto;
      padding: 6px 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: none;
      letter-spacing: 0.08em;
      white-space: nowrap;
      border-radius: 999px;
      min-width: 100px;
    }

    #convertBtn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.45);
    }

    .output-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .tabs {
      display: inline-flex;
      padding: 2px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid rgba(31, 41, 55, 1);
      gap: 2px;
    }

    .tab {
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 11px;
      border: none;
      cursor: pointer;
      background: transparent;
      color: var(--text-soft);
    }

    .tab.active {
      background: linear-gradient(135deg, #1d4ed8, #3b82f6);
      color: white;
    }

    .code {
      background: #020617;
      border-radius: 10px;
      border: 1px solid rgba(31, 41, 55, 1);
      padding: 14px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 14px;
      color: #e5e7eb;
      max-height: 400px;
      overflow: auto;
      position: relative;
    }

    .code pre {
      margin: 0;
      white-space: pre;
    }

    .log {
      background: #020617;
      border-radius: 10px;
      border: 1px solid rgba(31, 41, 55, 1);
      padding: 10px;
      font-family: ui-monospace, monospace;
      font-size: 13px;
      color: #9ca3af;
      max-height: 160px;
      overflow: auto;
      white-space: pre-wrap;
    }

    .progress {
      margin-top: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 1);
      overflow: hidden;
      border: 1px solid rgba(31, 41, 55, 1);
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(to right, #22c55e, #65a30d);
      box-shadow: 0 0 18px rgba(34, 197, 94, 0.75);
      transition: width 0.15s ease-out;
    }

    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      font-size: 13px;
      color: #6b7280;
    }

    .link {
      color: #60a5fa;
      text-decoration: none;
    }

    .link:hover {
      text-decoration: underline;
    }

    .site-footer {
      margin-top: 12px;
      padding: 16px 24px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-soft);
    }

    .site-footer-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      justify-content: center;
      text-align: center;
      margin-bottom: 10px;
    }

    .site-footer-section h3 {
      margin: 0 0 6px 0;
      font-size: 16px;
      color: var(--text);
      letter-spacing: 0.04em;
    }

    .site-footer-section p {
      margin: 0;
      font-size: 13px;
    }

    .site-footer-section .creation-date {
      display: inline-block;
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .site-footer a.footer-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #60a5fa;
      text-decoration: none;
      font-weight: 600;
    }

    .site-footer a.footer-link:hover {
      text-decoration: underline;
    }

    .site-footer-bottom {
      border-top: 1px solid var(--border);
      padding-top: 10px;
      font-size: 12px;
      color: var(--text-soft);
      text-align: center;
    }

    @media (max-width: 880px) {
      .app {
        grid-template-columns: 1fr;
      }
    }

    /* Modal CSS */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: #0f172a;
      width: 500px;
      max-width: 90%;
      border-radius: 12px;
      border: 1px solid rgba(31, 41, 55, 1);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      transform: scale(0.95);
      transition: transform 0.2s ease;
      overflow: hidden;
    }

    .modal-overlay.active .modal-content {
      transform: scale(1);
    }

    .modal-header {
      padding: 16px 20px;
      background: rgba(17, 24, 39, 0.8);
      border-bottom: 1px solid rgba(31, 41, 55, 1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
      color: #e5e7eb;
      letter-spacing: 0.04em;
    }

    .modal-body {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .modal-info {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
      line-height: 1.4;
    }

    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(55, 65, 81, 0.5);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .checkbox-item:hover {
      background: rgba(30, 41, 59, 0.8);
    }

    .checkbox-item input[type="checkbox"] {
      accent-color: #2563eb;
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .checkbox-item span {
      font-size: 13px;
      color: #d1d5db;
      user-select: none;
    }

    .modal-footer {
      padding: 16px 20px;
      background: rgba(15, 23, 42, 0.95);
      border-top: 1px solid rgba(31, 41, 55, 1);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn-danger {
      background: transparent;
      border: 1px solid #ef4444;
      color: #ef4444;
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    .link-action {
      font-size: 12px;
      color: #60a5fa;
      cursor: pointer;
      text-decoration: none;
      margin-right: auto;
      align-self: center;
    }

    .link-action:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="left">
      <div class="header">
        <div class="logo">
          <span class="logo-text">S</span>
          <img id="appIcon" src="assets/icon.png" alt="Spell Converter" />
        </div>
        <div class="title-block">
          <h1 id="titleMain">Spell Converter</h1>
          <div class="subtitle" id="subtitleMain">TFS 1.x apartir do 1.3+ compativel</div>
        </div>
        <div class="toolbar">
          <select id="langSelect" class="select">
            <option value="pt">PT</option>
            <option value="en">EN</option>
          </select>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title" id="inputCardTitle">Entrada</div>
          <span class="badge" id="stepBadge">Passo 1 Â· spells.xml</span>
        </div>

        <div class="field">
          <label id="selectLabel">Selecione a pasta contendo <b>spells.xml</b></label>
          <button class="btn btn-primary" id="selectFolderBtn" style="margin-bottom: 5px;">
            ðŸ“‚ <span id="chooseFolderText">Escolher Pasta</span>
          </button>
        </div>

        <div class="field">
          <label id="selectedPathLabel">Pasta selecionada:</label>
          <input type="text" id="basePath" placeholder="Nenhuma pasta selecionada" readonly />
        </div>
        <div class="field">
          <!-- VersÃ£o movida para o Modal -->
          <div class="status-line" style="margin-top: 5px;">
            <span id="versionDisplayLabel" style="font-size: 11px; color: #6b7280;">VersÃ£o alvo serÃ¡ selecionada ao
              converter.</span>
          </div>
        </div>

        <div class="status-line">
          <span class="status-warn">
            <span class="dot"></span>
            <span id="statusText">Aguardando pasta...</span>
          </span>
          <span id="spellCount">0 spells</span>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title" id="detectedCardTitle">Spells detectadas</div>
          <span class="badge" id="badgeMode">Tauri Mode</span>
        </div>

        <div class="spells-list">
          <table>
            <thead>
              <tr>
                <th id="thName">Nome</th>
                <th id="thWords">Words</th>
                <th id="thGroup">Grupo</th>
                <th id="thLvl">Lvl</th>
                <th id="thMana">Mana</th>
                <th id="thSoul">Soul</th>
                <th id="thPrem">Prem</th>
                <th id="thRange">Range</th>
                <th id="thCd">CD</th>
                <th id="thGrpCd">GrpCD</th>
                <th id="thML">ML</th>
                <th id="thChg">Chg</th>
                <th id="thBlkTyp">BlkTyp</th>
                <th id="thSecGrp">SecGrp</th>
                <th id="thSecLrn">SecLrn</th>
                <th id="thShwDesc">ShwDesc</th>
                <th id="thTgt">NeedTgt</th>
                <th id="thWpn">NeedWpn</th>
                <th id="thDir">Dir</th>
                <th id="thPName">PName</th>
                <th id="thParams">Params</th>
                <th id="thAfu">AFU</th>
                <th id="thAgg">Agg</th>
                <th id="thLearn">Learn</th>
                <th id="thBlock">Block</th>
                <th id="thSelf">Self</th>
                <th id="thCastSnd">CastSnd</th>
                <th id="thImpSnd">ImpSnd</th>
                <th id="thScript">Script</th>
              </tr>
            </thead>
            <tbody id="spellsTableBody">
            </tbody>
          </table>
        </div>

        <div class="status-line">
          <span class="pill">
            <span id="baseIdLabel">ID:</span> <input type="text" id="baseId" value="100" />
          </span>
          <button class="btn btn-primary" id="convertBtn">
            <span id="saveBtnText">ðŸ’¾ Converter</span>
          </button>
        </div>

        <div class="progress">
          <div class="progress-bar" id="progressBar"></div>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="card">
        <div class="output-header">
          <div class="card-title" id="outputTitle">SaÃ­da Â· RevScript (preview)</div>
          <div class="tabs">
            <button class="tab active" data-tab="single" id="tabSingle">Spell selecionada</button>
            <button class="tab" data-tab="all" id="tabAll">Todas (concat)</button>
          </div>
        </div>

        <div class="code" id="codeBox">
          <pre id="codeOutput">-- Selecione uma pasta e clique em "Salvar RevScripts".</pre>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title" id="logTitle">Log</div>
          <span class="badge" id="simBadge">SimulaÃ§Ã£o (Tauri)</span>
        </div>
        <div class="log" id="logBox"></div>
        <div class="footer">
          <span id="footerText">Os arquivos serÃ£o salvos na subpasta <b>/converter</b>.</span>
          <button class="btn btn-secondary" id="clearLogBtn"><span id="clearLogText">Limpar log</span></button>
        </div>
      </div>
      <div class="site-footer">
        <div class="site-footer-grid">
          <div class="site-footer-section info">
            <h3>Spell Converter para TFS</h3>
            <p>Sistema de conversÃ£o XML â†’ RevScript para TFS.</p>
          </div>
          <div class="site-footer-section developer">
            <span>Desenvolvido por</span>
            <a href="https://github.com/Mateuzktl" target="_blank" rel="noopener noreferrer" class="footer-link">
              <span>Mateus Roberto (@Mateuzkl)</span>
            </a>
            <span class="creation-date">13 de Dezembro de 2025</span>
          </div>
        </div>
        <div class="site-footer-bottom">
          <p>&copy; 2025 Spell Converter TFS. Todos os direitos reservados.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Attributes -->
  <div class="modal-overlay" id="attrModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Selecione os Atributos</div>
      </div>
      <div class="modal-body">
        <div class="modal-info">
          Selecione a versÃ£o alvo e os atributos que deseja preservar.
        </div>

        <div class="field" style="margin-bottom: 20px;">
          <label style="display:block; margin-bottom: 6px; color: #e5e7eb; font-size: 14px;">VersÃ£o TFS Alvo:</label>
          <select id="modalVersionSelect" class="select"
            style="width: 100%; padding: 10px; font-size: 14px; background: rgba(15, 23, 42, 0.8);">
            <option value="standard">TFS 1.5 MILHTORE TFS DOWNGRADE</option>
            <option value="custom">TFS 1.4.2/1.5 CUSTOM (com spellId)</option>
            <option value="nekiro_std">TFS 1.5 NEKIRO STANDARD</option>
          </select>
        </div>

        <div class="checkbox-grid" id="attrGrid">
          <!-- Checkboxes injetados via JS -->
        </div>
      </div>
      <div class="modal-footer">
        <a class="link-action" id="toggleAllBtn">Marcar/Desmarcar todos</a>
        <button class="btn btn-secondary" id="modalCancelBtn">Cancelar</button>
        <button class="btn btn-primary" id="modalConfirmBtn">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    class SpellData {
      constructor() {
        this.name = "";
        this.words = "";
        this.group = "";
        this.level = 0;
        this.mana = 0;
        this.soul = null;
        this.premium = false;
        this.selftarget = false;
        this.cooldown = 0;
        this.groupcooldown = null;
        this.needlearn = false;
        this.aggressive = null;
        this.blockwalls = null;
        this.range = null;
        this.vocations = [];
        this.scriptPath = "";
        this.id = 0;
        this.isRune = false;
        this.isConjuringSpell = false;
        this.runeItemId = null;
        this.needWeapon = false;
        this.needWeapon = false;
        this.needCasterTargetOrDirection = null;
        this.castSound = "";
        this.impactSound = "";
        this.allowfaruse = null;
        this.direction = false;
        this.playernameparam = false;
        this.params = false;
        this.magiclevel = 0;
        this.charges = 0;
        this.blocktype = "";
        this.secondarygroup = "";
        this.secondaryneedlearn = false;
        this.showInDescription = null;
      }
    }

    const availableAttributes = [
      { id: "spellid", label: "Spell ID (spell:spellId)" },
      { id: "groupCooldown", label: "Group Cooldown" },
      { id: "needTarget", label: "Need Target (casterTargetOrDirection)" },
      { id: "needWeapon", label: "Need Weapon" },
      { id: "mana", label: "Mana" },
      { id: "soul", label: "Soul" },
      { id: "cooldown", label: "Cooldown" },
      { id: "aggressive", label: "Aggressive" },
      { id: "needLearn", label: "Need Learn" },
      { id: "blockWalls", label: "Block Walls" },
      { id: "premium", label: "Premium" },
      { id: "range", label: "Range" },
      { id: "castSound", label: "Cast Sound" },
      { id: "castSound", label: "Cast Sound" },
      { id: "impactSound", label: "Impact Sound" },
      { id: "allowFarUse", label: "Allow Far Use" },
      { id: "direction", label: "Need Direction" },
      { id: "playerNameParam", label: "Player Name Param" },
      { id: "params", label: "Has Params" },
      { id: "magicLevel", label: "Magic Level" },
      { id: "charges", label: "Charges" },
      { id: "blockType", label: "Block Type" },
      { id: "secondaryGroup", label: "Sec. Group" },
      { id: "secondaryNeedLearn", label: "Sec. Learn" },
      { id: "showInDescription", label: "Show Desc." }
    ];

    // Default configuration: All enabled
    let activeAttributes = new Set(availableAttributes.map(a => a.id));
    let pendingVersion = null;

    // Modal elements
    const attrModal = document.getElementById("attrModal");
    const attrGrid = document.getElementById("attrGrid");
    const toggleAllBtn = document.getElementById("toggleAllBtn");
    const modalCancelBtn = document.getElementById("modalCancelBtn");
    const modalConfirmBtn = document.getElementById("modalConfirmBtn");

    const selectFolderBtn = document.getElementById("selectFolderBtn");
    const basePathInput = document.getElementById("basePath");
    const statusText = document.getElementById("statusText");
    const spellCount = document.getElementById("spellCount");
    const tableBody = document.getElementById("spellsTableBody");
    const codeOutput = document.getElementById("codeOutput");
    const convertBtn = document.getElementById("convertBtn");
    const progressBar = document.getElementById("progressBar");
    const logBox = document.getElementById("logBox");
    const clearLogBtn = document.getElementById("clearLogBtn");
    const baseIdInput = document.getElementById("baseId");
    const tabs = document.querySelectorAll(".tab");
    const langSelect = document.getElementById("langSelect");
    const versionStandard = null;
    const versionCustom = null;
    const versionNekiroStd = null;
    let targetVersion = "standard";

    // ... i18n object ...
    const i18n = {
      pt: {
        titleMain: "Spell Converter",
        subtitleMain: "TFS 1.x apartir do 1.3+ compativel",
        inputCardTitle: "Entrada",
        stepBadge: "Passo 1 Â· spells.xml",
        selectLabel: "Selecione a pasta contendo <b>spells.xml</b>",
        chooseFolderText: "Escolher Pasta",
        selectedPathLabel: "Pasta selecionada:",
        detectedCardTitle: "Spells detectadas",
        baseIdLabel: "ID base:",
        saveBtnText: "ðŸ’¾ Converter",
        outputTitle: "SaÃ­da Â· RevScript (preview)",
        tabSingle: "Spell selecionada",
        tabAll: "Todas (concat)",
        logTitle: "Log",
        simBadge: "SimulaÃ§Ã£o (Tauri)",
        footerText: "Os arquivos serÃ£o salvos na subpasta <b>/converter</b>.",
        clearLogText: "Limpar log"
        , versionTargetLabel: "TFS Version Target"
        , versionStandardTitle: "TFS 1.5 MILHTORE TFS DOWNGRADE"
        , versionStandardDesc: "Sem spellId (Milhtore/Downgrade)"
        , versionCustomTitle: "TFS 1.4.2 / 1.5 CUSTOM"
        , versionCustomDesc: "Nekiro/Downgrade (com spellId)"
        , versionNekiroTitle: "TFS 1.5 NEKIRO STANDARD"
        , versionNekiroDesc: "Sem spellId; com groupCooldown"
        , headerGenerated: "-- gerado por Spell Converter"
        , headerOriginal: "-- script original"
        , headerNoOriginal: "-- [Aviso] Script original nÃ£o encontrado, lÃ³gica genÃ©rica inserida."
      },
      en: {
        titleMain: "Spell Converter",
        subtitleMain: "TFS 1.x (1.3+ compatible)",
        inputCardTitle: "Input",
        stepBadge: "Step 1 Â· spells.xml",
        selectLabel: "Select the folder containing <b>spells.xml</b>",
        chooseFolderText: "Choose Folder",
        selectedPathLabel: "Selected folder:",
        detectedCardTitle: "Detected spells",
        baseIdLabel: "Base ID:",
        saveBtnText: "ðŸ’¾ Convert",
        outputTitle: "Output Â· RevScript (preview)",
        tabSingle: "Selected spell",
        tabAll: "All (concat)",
        logTitle: "Log",
        simBadge: "Simulation (Tauri)",
        footerText: "Files will be saved under <b>/converter</b>.",
        clearLogText: "Clear log"
        , versionTargetLabel: "TFS Version Target"
        , versionStandardTitle: "TFS 1.5 MILHTORE TFS DOWNGRADE"
        , versionStandardDesc: "No spellId (Milhtore/Downgrade)"
        , versionCustomTitle: "TFS 1.4.2 / 1.5 CUSTOM"
        , versionCustomDesc: "Nekiro/Downgrade (with spellId)"
        , versionNekiroTitle: "TFS 1.5 NEKIRO STANDARD"
        , versionNekiroDesc: "No spellId; with groupCooldown"
        , headerGenerated: "-- generated by Spell Converter"
        , headerOriginal: "-- original script"
        , headerNoOriginal: "-- [Warning] Original script not found, generic logic inserted."
      }
    };
    function applyLang(lang) {
      const t = i18n[lang] || i18n.pt;
      document.getElementById("titleMain").textContent = t.titleMain;
      document.getElementById("subtitleMain").textContent = t.subtitleMain;
      document.getElementById("inputCardTitle").textContent = t.inputCardTitle;
      document.getElementById("stepBadge").textContent = t.stepBadge;
      document.getElementById("selectLabel").innerHTML = t.selectLabel;
      document.getElementById("chooseFolderText").textContent = t.chooseFolderText;
      document.getElementById("selectedPathLabel").textContent = t.selectedPathLabel;
      document.getElementById("detectedCardTitle").textContent = t.detectedCardTitle;
      document.getElementById("baseIdLabel").textContent = t.baseIdLabel;
      document.getElementById("saveBtnText").textContent = t.saveBtnText;
      document.getElementById("outputTitle").textContent = t.outputTitle;
      document.getElementById("tabSingle").textContent = t.tabSingle;
      document.getElementById("tabAll").textContent = t.tabAll;
      document.getElementById("logTitle").textContent = t.logTitle;
      document.getElementById("simBadge").textContent = t.simBadge;
      document.getElementById("footerText").innerHTML = t.footerText;
      document.getElementById("clearLogText").textContent = t.clearLogText;
      document.getElementById("thName").textContent = lang === "en" ? "Name" : "Nome";
      document.getElementById("thWords").textContent = lang === "en" ? "Words" : "Words";
      document.getElementById("thGroup").textContent = lang === "en" ? "Group" : "Grupo";
      document.getElementById("thLvl").textContent = lang === "en" ? "Lvl" : "Lvl";
      document.getElementById("thMana").textContent = lang === "en" ? "Mana" : "Mana";
      document.getElementById("thPrem").textContent = lang === "en" ? "Prem" : "Prem";
      document.getElementById("thRange").textContent = lang === "en" ? "Range" : "Range";
      document.getElementById("thCd").textContent = lang === "en" ? "CD" : "CD";
      document.getElementById("thScript").textContent = lang === "en" ? "Script" : "Script";
      document.getElementById("statusText").textContent = lang === "en" ? "Waiting for folder..." : "Aguardando pasta...";
      const badgeMode = document.getElementById("badgeMode");
      if (badgeMode) badgeMode.textContent = lang === "en" ? "Tauri Mode" : "Tauri Mode";
      const vt = document.getElementById("versionTargetLabel");
      if (vt) vt.textContent = t.versionTargetLabel;
      const vsTitle = document.getElementById("versionStandardTitle");
      const vsDesc = document.getElementById("versionStandardDesc");
      const vcTitle = document.getElementById("versionCustomTitle");
      const vcDesc = document.getElementById("versionCustomDesc");
      const nkTitle = document.getElementById("versionNekiroTitle");
      const nkDesc = document.getElementById("versionNekiroDesc");
      if (vsTitle) vsTitle.textContent = t.versionStandardTitle;
      if (vsDesc) vsDesc.textContent = t.versionStandardDesc;
      if (vcTitle) vcTitle.textContent = t.versionCustomTitle;
      if (vcDesc) vcDesc.textContent = t.versionCustomDesc;
      if (nkTitle) nkTitle.textContent = t.versionNekiroTitle;
      if (nkDesc) nkDesc.textContent = t.versionNekiroDesc;
    }
    function txt(key) {
      const lang = (langSelect && langSelect.value) || "pt";
      const dict = i18n[lang] || i18n.pt;
      return dict[key] || key;
    }
    function initPrefs() {
      const savedLang = localStorage.getItem("lang") || "pt";
      langSelect.value = savedLang;
      applyLang(savedLang);
    }
    langSelect.addEventListener("change", () => {
      const v = langSelect.value;
      localStorage.setItem("lang", v);
      applyLang(v);
    });


    let spells = [];
    let lastAllCode = "";
    let pastaEntrada = "";
    let tauriAPI = null;


    document.addEventListener('DOMContentLoaded', async () => {
      if (window.__TAURI__) {
        tauriAPI = window.__TAURI__;
        if (!tauriAPI.invoke && tauriAPI.core) {
          tauriAPI.invoke = tauriAPI.core.invoke;
        }
        console.log('Tauri API carregada com sucesso!');
      } else {
        console.error('Tauri API nÃ£o encontrada. Rodando em modo browser?');
      }
      initPrefs();
      // Old buttons removed.

      // Modal Logic

      // Convert Button now opens Modal!
      convertBtn.addEventListener("click", () => {
        if (!spells.length) {
          alert("Carregue as spells primeiro!");
          return;
        }
        if (!pastaEntrada) {
          alert("Pasta de entrada nÃ£o definida.");
          return;
        }
        openAttributeModal();
      });

      function openAttributeModal() {
        renderCheckboxes();
        attrModal.classList.add("active");
      }

      // ... (close, render, confirm) ...

      function closeAttributeModal() {
        attrModal.classList.remove("active");
      }

      function renderCheckboxes() {
        attrGrid.innerHTML = "";
        availableAttributes.forEach(attr => {
          const div = document.createElement("div");
          div.className = "checkbox-item";
          div.onclick = (e) => {
            // Toggle checkbox when clicking the row, avoiding double toggle if clicking input directly
            if (e.target.tagName !== 'INPUT') {
              const cb = div.querySelector('input');
              cb.checked = !cb.checked;
            }
          };

          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.id = `attr_${attr.id}`;
          cb.checked = activeAttributes.has(attr.id);

          const span = document.createElement("span");
          span.textContent = attr.label;

          div.appendChild(cb);
          div.appendChild(span);
          attrGrid.appendChild(div);
        });
      }

      toggleAllBtn.addEventListener("click", () => {
        const cbs = attrGrid.querySelectorAll("input[type='checkbox']");
        const allChecked = Array.from(cbs).every(c => c.checked);
        cbs.forEach(c => c.checked = !allChecked);
      });

      modalCancelBtn.addEventListener("click", closeAttributeModal);

      modalConfirmBtn.addEventListener("click", () => {
        // 1. Get Version
        const sel = document.getElementById("modalVersionSelect");
        targetVersion = sel.value;

        // 2. Get Attributes
        const cbs = attrGrid.querySelectorAll("input[type='checkbox']");
        activeAttributes.clear();
        cbs.forEach(c => {
          if (c.checked) {
            const id = c.id.replace("attr_", "");
            activeAttributes.add(id);
          }
        });

        console.log("[Debug] Confirmed. Version:", targetVersion);
        console.log("[Debug] Active Attributes:", Array.from(activeAttributes));

        closeAttributeModal();

        // 3. Start Conversion Process (moved from old convertBtn)
        startConversionProcess();
      });

      async function startConversionProcess() {
        const sep = pastaEntrada.includes("\\") ? "\\" : "/";
        const outputFolder = `${pastaEntrada}${sep}converter`;

        log(`Iniciando conversÃ£o de ${spells.length} spells... (VersÃ£o: ${targetVersion})`);
        progressBar.style.width = "0%";

        let i = 0;
        const total = spells.length;

        async function step() {
          if (i >= total) {
            progressBar.style.width = "100%";
            log(`ConcluÃ­do! Arquivos salvos em: ${outputFolder}`);
            alert("Processo finalizado!");

            // Refresh preview with last spell
            updateTable();
            if (spells.length) {
              const lastSpell = spells[spells.length - 1];
              if (lastSpell.convertedScript) codeOutput.textContent = lastSpell.convertedScript;
            }
            return;
          }

          const spell = spells[i];
          let content = "";
          let originalLua = "";

          if (spell.scriptPath) {
            const scriptAbsPath = `${pastaEntrada}${sep}scripts${sep}${spell.scriptPath}`;
            try {
              originalLua = await tauriAPI.invoke('read_file', { path: scriptAbsPath });
            } catch (e) {
              log(`[Aviso] Script nÃ£o achado: ${spell.scriptPath}`);
            }
          }

          content = generateSingleSpellRevScript(spell, originalLua);
          spell.convertedScript = content;

          let relPath = spell.scriptPath || `custom/${spell.name.replace(/\s+/g, '_')}.lua`;
          const finalPath = `${outputFolder}${sep}${relPath}`;

          try {
            await tauriAPI.invoke('save_file', { path: finalPath, content: content });
          } catch (e) {
            log(`Erro ao salvar ${relPath}: ${e}`);
          }

          i++;
          const pct = Math.round((i / total) * 100);
          progressBar.style.width = pct + "%";

          if (i % 10 === 0) {
            setTimeout(step, 5);
          } else {
            step();
          }
        }

        step();
      }

      const iconEl = document.getElementById('appIcon');
      const logoText = document.querySelector('.logo-text');
      function toggleLogo() {
        if (iconEl && iconEl.complete && iconEl.naturalWidth > 0) {
          iconEl.style.display = 'block';
          if (logoText) logoText.style.display = 'none';
        }
      }
      if (iconEl) {
        if (iconEl.complete) {
          toggleLogo();
        } else {
          iconEl.addEventListener('load', toggleLogo);
          iconEl.addEventListener('error', () => {
            if (logoText) logoText.style.display = 'flex';
          });
        }
      }
    });

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logBox.textContent += `[${time}] ${msg}\n`;
      logBox.scrollTop = logBox.scrollHeight;
    }

    function clearTable() {
      tableBody.innerHTML = "";
    }

    function updateTable() {
      clearTable();
      spells.forEach((s, index) => {
        const tr = document.createElement("tr");
        tr.style.cursor = "pointer";
        tr.addEventListener("click", async () => {
          if (s.convertedScript) {
            codeOutput.textContent = s.convertedScript;
            return;
          }
          let originalLua = "";
          if (s.scriptPath && pastaEntrada) {
            const sepLocal = pastaEntrada.includes("\\") ? "\\" : "/";
            const scriptAbsPath = `${pastaEntrada}${sepLocal}scripts${sepLocal}${s.scriptPath}`;
            try {
              originalLua = await tauriAPI.invoke('read_file', { path: scriptAbsPath });
            } catch (e) { }
          }
          const code = generateSingleSpellRevScript(s, originalLua);
          codeOutput.textContent = code;
        });

        const groupClass =
          s.group === "attack"
            ? "tag tag-attack"
            : s.group === "support"
              ? "tag tag-support"
              : s.group === "healing"
                ? "tag tag-healing"
                : "tag";

        const premiumIcon = s.premium ? (langSelect.value === "en" ? "Yes" : "Sim") : "-";
        const cooldownSec = s.cooldown ? `${(s.cooldown / 1000).toFixed(1)}s` : "-";

        // Helper for boolean
        const boolIcon = (val) => val ? "<span style='color:#22c55e'>âœ”</span>" : "<span style='color:#374151'>-</span>";
        // Helper for text
        const textVal = (val) => val ? val : "<span style='color:#374151'>-</span>";

        const scriptName = s.scriptPath
          ? s.scriptPath.split('/').pop().split('\\').pop().replace('.lua', '')
          : "-";

        tr.innerHTML = `
          <td style="font-weight: 600;">${s.name || "-"}</td>
          <td style="color: #60a5fa; font-family: monospace; font-size: 12px;">${s.words || "-"}</td>
          <td><span class="${groupClass}">${s.group || "-"}</span></td>
          <td>${s.level || "-"}</td>
          <td style="color: #38bdf8;">${s.mana || "-"}</td>
          <td>${s.soul || "-"}</td>
          <td style="text-align: center;">${premiumIcon}</td>
          <td style="text-align: center;">${s.range || "-"}</td>
          <td style="color: #facc15; font-size: 12px;">${cooldownSec}</td>
          <td style="color: #facc15; font-size: 12px;">${s.groupcooldown ? (s.groupcooldown / 1000).toFixed(1) + 's' : '-'}</td>
          <td>${s.magiclevel || "-"}</td>
          <td>${s.charges || "-"}</td>
          <td style="font-size:10px;">${textVal(s.blocktype)}</td>
          <td style="font-size:10px;">${textVal(s.secondarygroup)}</td>
          <td style="text-align: center;">${boolIcon(s.secondaryneedlearn)}</td>
          <td style="text-align: center;">${boolIcon(s.showInDescription)}</td>
          <td style="text-align: center;">${boolIcon(s.needCasterTargetOrDirection)}</td>
          <td style="text-align: center;">${boolIcon(s.needWeapon)}</td>
          <td style="text-align: center;">${boolIcon(s.direction)}</td>
          <td style="text-align: center;">${boolIcon(s.playernameparam)}</td>
          <td style="text-align: center;">${boolIcon(s.params)}</td>
          <td style="text-align: center;">${boolIcon(s.allowfaruse)}</td>
          <td style="text-align: center;">${boolIcon(s.aggressive)}</td>
          <td style="text-align: center;">${boolIcon(s.needlearn)}</td>
          <td style="text-align: center;">${boolIcon(s.blockwalls)}</td>
          <td style="text-align: center;">${boolIcon(s.selftarget)}</td>
          <td style="font-size:10px;">${textVal(s.castSound)}</td>
          <td style="font-size:10px;">${textVal(s.impactSound)}</td>
          <td style="color: #9ca3af; font-size: 11px; font-family: monospace;">${scriptName}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    function parseBoolAttr(value, defaultVal) {
      if (value === null || value === undefined || value === "") return defaultVal;
      if (value === "1" || value === "true" || value === "yes") return true;
      if (value === "0" || value === "false" || value === "no") return false;
      return defaultVal;
    }

    function mapVocationToRev(vocName) {
      const lower = vocName.toLowerCase();
      if (lower === "sorcerer") return ["sorcerer;true", "master sorcerer;true"];
      if (lower === "druid") return ["druid;true", "elder druid;true"];
      if (lower === "paladin") return ["paladin;true", "royal paladin;true"];
      if (lower === "knight") return ["knight;true", "elite knight;true"];
      return [`${lower};true`];
    }

    function parseSpellsXml(text) {
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, "application/xml");

      const errors = xml.getElementsByTagName("parsererror");
      if (errors.length) {
        throw new Error("XML invÃ¡lido");
      }

      const instants = Array.from(xml.getElementsByTagName("instant"));
      const runes = Array.from(xml.getElementsByTagName("rune"));

      const all = [];
      const spellsByWords = {};

      function processNode(node, type) {
        const s = new SpellData();
        s.name = node.getAttribute("name") || "";
        s.words = node.getAttribute("words") || "";
        s.group = node.getAttribute("group") || (type === "rune" ? "attack" : "");
        s.level = parseInt(node.getAttribute("level") || "0", 10);
        s.mana = parseInt(node.getAttribute("mana") || "0", 10);
        const soulAttr = node.getAttribute("soul");
        s.soul = soulAttr ? parseInt(soulAttr, 10) : null;
        s.premium = parseBoolAttr(node.getAttribute("premium"), false);
        s.selftarget = parseBoolAttr(node.getAttribute("selftarget"), false);
        s.cooldown = parseInt(node.getAttribute("cooldown") || "0", 10);

        // Robust reading for groupCooldown
        const gc = node.getAttribute("groupcooldown") || node.getAttribute("groupCooldown") || node.getAttribute("group-cooldown");
        s.groupcooldown = gc ? parseInt(gc, 10) : null;

        s.needlearn = parseBoolAttr(node.getAttribute("needlearn"), false);
        const agg = node.getAttribute("aggressive");
        s.aggressive = agg != null ? parseBoolAttr(agg, true) : null;
        const bw = node.getAttribute("blockwalls") || node.getAttribute("blockWalls");
        s.blockwalls = bw != null ? parseBoolAttr(bw, false) : null;
        const rangeAttr = node.getAttribute("range");
        s.range = rangeAttr ? parseInt(rangeAttr, 10) : null;
        const ctodAttr = node.getAttribute("casterTargetOrDirection") || node.getAttribute("casterTargetordirection") || node.getAttribute("castertargetordirection") || node.getAttribute("needtarget") || node.getAttribute("needTarget");
        s.needCasterTargetOrDirection = ctodAttr ? parseBoolAttr(ctodAttr, false) : null;
        s.scriptPath = node.getAttribute("script") || "";

        // Robust reading for sounds
        s.castSound = node.getAttribute("castSound") || node.getAttribute("castsound") || node.getAttribute("cast-sound") || "";
        s.impactSound = node.getAttribute("impactSound") || node.getAttribute("impactsound") || node.getAttribute("impact-sound") || "";

        const afu = node.getAttribute("allowfaruse") || node.getAttribute("allowFarUse");
        s.allowfaruse = afu != null ? parseBoolAttr(afu, true) : null;

        s.direction = parseBoolAttr(node.getAttribute("direction"), false);
        s.playernameparam = parseBoolAttr(node.getAttribute("playernameparam"), false);
        s.params = parseBoolAttr(node.getAttribute("params"), false);

        s.magiclevel = parseInt(node.getAttribute("magiclevel") || "0", 10);
        s.charges = parseInt(node.getAttribute("charges") || "0", 10);
        s.blocktype = node.getAttribute("blocktype") || "";
        s.secondarygroup = node.getAttribute("secondarygroup") || "";
        s.secondaryneedlearn = parseBoolAttr(node.getAttribute("secondaryneedlearn"), false);
        const shwDesc = node.getAttribute("showInDescription") || node.getAttribute("showindescription");
        s.showInDescription = shwDesc !== null ? parseBoolAttr(shwDesc, true) : null;

        const needWpnAttr = node.getAttribute("needweapon") || node.getAttribute("needWeapon");
        if (needWpnAttr) {
          s.needWeapon = needWpnAttr === "1" || needWpnAttr === "true" || needWpnAttr === "yes";
        } else {
          s.needWeapon = false;
        }

        if (type === "rune") {
          s.isRune = true;
          const itemId = node.getAttribute("id");
          s.runeItemId = itemId ? parseInt(itemId, 10) : 0;
          s.id = s.runeItemId;
          s.isConjuringSpell = false;
        } else {
          s.isRune = false;
          s.id = 0;
          s.isConjuringSpell = s.words && s.words.length > 0;
        }

        const vocNodes = Array.from(node.getElementsByTagName("vocation"));
        const vocsFormatted = [];
        vocNodes.forEach(v => {
          const name = v.getAttribute("name");
          if (!name) return;
          const mapped = mapVocationToRev(name);
          mapped.forEach(m => {
            if (!vocsFormatted.includes(m)) {
              vocsFormatted.push(m);
            }
          });
        });
        s.vocations = vocsFormatted;

        if (s.words) {
          const key = s.words.toLowerCase();
          if (spellsByWords[key]) {
            const existing = spellsByWords[key];
            s.vocations.forEach(v => {
              if (!existing.vocations.includes(v)) {
                existing.vocations.push(v);
              }
            });
            if (!existing.scriptPath && s.scriptPath) {
              existing.scriptPath = s.scriptPath;
            }
            console.log(`[Info] Spell duplicada mesclada: ${s.words} (${s.name})`);
            return;
          } else {
            spellsByWords[key] = s;
          }
        }

        all.push(s);
      }

      instants.forEach(n => processNode(n, "instant"));
      runes.forEach(n => processNode(n, "rune"));

      return all;
    }

    function cleanOldSpellFunction(luaCode) {
      let cleaned = luaCode.replace(/function\s+onCastSpell\s*\([^)]*\)[\s\S]*?\nend/gi, "");
      cleaned = cleaned.replace(/function\s+onCastSpell\s*\([^)]*\)\s+return\s+[^\n]+\s+end/gi, "");
      cleaned = cleaned.replace(/function\s+spell\.onCastSpell\s*\([^)]*\)[\s\S]*?\nend/gi, "");
      cleaned = cleaned.replace(/function\s+spell\.onCastSpell\s*\([^)]*\)\s+return\s+[^\n]+\s+end/gi, "");
      cleaned = cleaned.replace(/\n\n\n+/g, "\n\n");
      return cleaned.trim();
    }

    function generateSingleSpellRevScript(s, originalLua) {
      let id = s.id;

      if (!s.isRune && id === 0) {
        const baseId = parseInt(baseIdInput.value || "100", 10);
        const idx = spells.indexOf(s);
        id = baseId + (idx >= 0 ? idx : 0);
        s.id = id;
      }

      const spellType = s.isRune ? "rune" : "instant";

      const vocStr = s.vocations.length
        ? s.vocations.map(v => `"${v.split(';')[0]}"`).join(", ")
        : "";

      // 1. Calculate properties lines
      const propLines = [];
      propLines.push(`spell:group("${s.group || 'support'}")`);

      propLines.push(`spell:id(${id})`);
      if (activeAttributes.has("spellid")) {
        propLines.push(`spell:spellId(${id})`);
      }

      if (s.isRune && s.runeItemId) {
        propLines.push(`spell:runeId(${s.runeItemId})`);
      }

      if (s.name) {
        propLines.push(`spell:name("${s.name}")`);
      }
      if (s.words && !s.isRune) {
        propLines.push(`spell:words("${s.words}")`);
      }
      if (s.level) {
        propLines.push(`spell:level(${s.level})`);
      }
      if (s.mana && activeAttributes.has("mana")) {
        propLines.push(`spell:mana(${s.mana})`);
      }
      if (s.soul !== null && activeAttributes.has("soul")) {
        propLines.push(`spell:soul(${s.soul})`);
      }

      if (s.needWeapon && activeAttributes.has("needWeapon")) {
        propLines.push("spell:needWeapon(true)");
      }

      if (s.premium && activeAttributes.has("premium")) {
        propLines.push("spell:isPremium(true)");
      }

      if (s.selftarget) {
        propLines.push("spell:isSelfTarget(true)");
      }

      if (s.range !== null && activeAttributes.has("range")) {
        propLines.push(`spell:range(${s.range})`);
      }

      if (s.needCasterTargetOrDirection === true && activeAttributes.has("needTarget")) {
        propLines.push("spell:needCasterTargetOrDirection(true)");
      }

      if (s.blockwalls === true && activeAttributes.has("blockWalls")) {
        propLines.push("spell:blockWalls(true)");
      }

      if (s.castSound && activeAttributes.has("castSound")) {
        propLines.push(`spell:castSound("${s.castSound}")`);
      }
      if (s.impactSound && activeAttributes.has("impactSound")) {
        propLines.push(`spell:impactSound("${s.impactSound}")`);
      }

      let cooldownMs = s.cooldown || 2000;
      let groupCdMs = s.groupcooldown || 2000;

      if (activeAttributes.has("cooldown")) {
        propLines.push(`spell:cooldown(${Math.round(cooldownMs / 1000)} * 1000)`);
      }

      if (activeAttributes.has("groupCooldown")) {
        propLines.push(`spell:groupCooldown(${Math.round(groupCdMs / 1000)} * 1000)`);
      }

      if (activeAttributes.has("needLearn")) {
        propLines.push(`spell:needLearn(${s.needlearn ? "true" : "false"})`);
      }

      if (s.aggressive !== null && activeAttributes.has("aggressive")) {
        propLines.push(`spell:isAggressive(${s.aggressive ? "true" : "false"})`);
      }

      if (s.allowfaruse !== null && activeAttributes.has("allowFarUse")) {
        propLines.push(`spell:allowFarUse(${s.allowfaruse ? "true" : "false"})`);
      }

      if (s.direction && activeAttributes.has("direction")) {
        propLines.push("spell:needDirection(true)");
      }

      if (s.playernameparam && activeAttributes.has("playerNameParam")) {
        propLines.push("spell:playerNameParam(true)");
      }

      if (s.params && activeAttributes.has("params")) {
        propLines.push("spell:hasParams(true)");
      }

      if (s.magiclevel > 0 && activeAttributes.has("magicLevel")) {
        propLines.push(`spell:magicLevel(${s.magiclevel})`);
      }
      if (s.charges > 0 && activeAttributes.has("charges")) {
        propLines.push(`spell:charges(${s.charges})`); // Or runeCharges if rune
      }
      if (s.blocktype && activeAttributes.has("blockType")) {
        propLines.push(`spell:blockType("${s.blocktype}")`);
      }
      if (s.secondarygroup && activeAttributes.has("secondaryGroup")) {
        propLines.push(`spell:secondaryGroup("${s.secondarygroup}")`);
      }
      if (s.secondaryneedlearn && activeAttributes.has("secondaryNeedLearn")) {
        propLines.push("spell:secondaryNeedLearn(true)");
      }
      if (s.showInDescription === false && activeAttributes.has("showInDescription")) {
        propLines.push("spell:showInDescription(false)");
      } else if (s.showInDescription === true && activeAttributes.has("showInDescription")) {
        propLines.push("spell:showInDescription(true)");
      }

      if (vocStr) {
        propLines.push(`spell:vocation(${vocStr})`);
      }

      // 2. Assemble Script
      const parts = [];
      parts.push(txt("headerGenerated"));

      let hasOriginalLogic = false;
      if (originalLua && /function\s+onCastSpell\s*\(/.test(originalLua)) {
        hasOriginalLogic = true;
      }

      if (hasOriginalLogic) {
        parts.push(txt("headerOriginal"));
        const match = originalLua.match(/function\s+onCastSpell\s*\(/);
        const idx = match.index;
        const pre = originalLua.substring(0, idx);
        const post = originalLua.substring(idx);

        if (pre.trim().length > 0) {
          parts.push(pre.trimEnd());
          parts.push("");
        }

        parts.push(`local spell = Spell("${spellType}")`);

        const renamedPost = post.replace(/function\s+onCastSpell\s*\(/, "function spell.onCastSpell(");
        parts.push(renamedPost);
        parts.push("");

        parts.push(propLines.join("\n"));
        parts.push("spell:register()");

      } else {
        if (originalLua && originalLua.trim().length > 0) {
          parts.push(txt("headerOriginal"));
          parts.push(cleanOldSpellFunction(originalLua));
          parts.push("");
        } else {
          parts.push(txt("headerNoOriginal"));
          parts.push("local combat = Combat()");
          parts.push("combat:setParameter(COMBAT_PARAM_TYPE, COMBAT_ENERGYDAMAGE)");
          parts.push("combat:setParameter(COMBAT_PARAM_EFFECT, CONST_ME_ENERGYAREA)");
          parts.push("");
          parts.push("function onGetFormulaValues(player, level, maglevel)");
          parts.push("\tlocal min = (level / 5) + (maglevel * 1.4) + 8");
          parts.push("\tlocal max = (level / 5) + (maglevel * 2.2) + 14");
          parts.push("\treturn -min, -max");
          parts.push("end");
          parts.push("");
          parts.push("combat:setCallback(CALLBACK_PARAM_LEVELMAGICVALUE, onGetFormulaValues)");
          parts.push("");
        }

        parts.push(`local spell = Spell("${spellType}")`);
        parts.push("");

        if (targetVersion === "standard") {
          parts.push("function spell.onCastSpell(creature, variant) return combat:execute(creature, variant) end");
        } else {
          parts.push("function spell.onCastSpell(creature, variant, isHotkey)");
          parts.push("\treturn combat:execute(creature, variant)");
          parts.push("end");
        }
        parts.push("");

        parts.push(propLines.join("\n"));
        parts.push("spell:register()");
      }

      parts.push("");
      return parts.join("\n");
    }

    function generateAllCode() {
      const all = spells.map(s => `-- ${s.name}\n${generateSingleSpellRevScript(s)}`).join("\n\n");
      lastAllCode = all;
      return all;
    }


    selectFolderBtn.addEventListener("click", async () => {
      try {
        if (!tauriAPI) {
          alert("Erro: Tauri nÃ£o detectado.");
          return;
        }

        const folder = await tauriAPI.invoke('select_folder');
        if (!folder) return;

        pastaEntrada = folder;
        basePathInput.value = folder;

        statusText.textContent = "Lendo spells.xml...";
        statusText.parentElement.classList.add("status-warn");

        const sep = folder.includes("\\") ? "\\" : "/";
        const xmlPath = `${folder}${sep}spells.xml`;

        try {
          const xmlContent = await tauriAPI.invoke('read_file', { path: xmlPath });
          spells = parseSpellsXml(xmlContent);
          spellCount.textContent = `${spells.length} spells`;
          statusText.textContent = "XML carregado OK!";
          statusText.parentElement.classList.remove("status-warn");
          statusText.parentElement.classList.add("status-ok");
          updateTable();
          log(`Lido spells.xml com ${spells.length} entradas.`);

          if (spells.length) {
            if (spells[0].scriptPath) {
              const scriptAbsPath = `${pastaEntrada}${sep}scripts${sep}${spells[0].scriptPath}`;
              try {
                const lua = await tauriAPI.invoke('read_file', { path: scriptAbsPath });
                codeOutput.textContent = generateSingleSpellRevScript(spells[0], lua);
              } catch (e) {
                codeOutput.textContent = generateSingleSpellRevScript(spells[0]);
              }
            } else {
              codeOutput.textContent = generateSingleSpellRevScript(spells[0]);
            }
          }

        } catch (err) {
          statusText.textContent = "Erro ao ler spells.xml";
          log("Falha ao abrir spells.xml: " + err);
          spells = [];
          updateTable();
        }

      } catch (err) {
        alert('Erro Tauri: ' + err);
      }
    });

    // Removed old convertBtn logic since it's now in startConversionProcess
    // convertBtn.addEventListener("click", ... );

    clearLogBtn.addEventListener("click", () => {
      logBox.textContent = "";
    });

    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        if (tab.dataset.tab === "single") {
          log("Nota: VisualizaÃ§Ã£o single utiliza apenas dados do XML ou o Ãºltimo carregado.");
          if (spells.length) {
            codeOutput.textContent = generateSingleSpellRevScript(spells[0]);
          }
        } else {
          if (!lastAllCode && spells.length) {
            lastAllCode = generateAllCode();
          }
          codeOutput.textContent = lastAllCode || "-- Nenhuma spell carregada.";
        }
      });
    });
  </script>
</body>

</html>